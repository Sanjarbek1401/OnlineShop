{% extends "shop/base.html" %}
{% load static %}
{% block title %}
    {{ product.name }}
{% endblock %}

{% block content %}
    <style>
        .rating {
            font-size: 20px;
            color: gold;
        }

        .star {
            margin-right: 2px;
        }

        .star.filled {
            color: gold;
        }

        .old-price {
            text-decoration: line-through;
            color: grey;
        }

        .discounted-price {
            font-weight: bold;
            color: red;
        }

        .product-detail {
            position: relative; /* O'zgaruvchi joylashuv uchun */
        }

        .like-button {
            position: absolute; /* Suratning o'ng burchagida joylashishi uchun */
            top: 10px; /* Yuqoridan masofa */
            right: 10px; /* O'ngdan masofa */
            font-size: 24px; /* Yurakcha o'lchamini kattalashtirish */
            border: none; /* Ramka o'chiriladi */
            background: transparent; /* Orqa fon o'chiriladi */
            cursor: pointer; /* Ko'rsatgichni o'zgartirish */
            transition: color 0.3s; /* Qizarganda yumshoq o'tish */
        }

        .like-button.liked {
            color: #ff6961; /* Qizil rangda ko'rsatish */
        }
    </style>

    <div class="product-detail">
        <img src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'img/no_image.png' %}{% endif %}" alt="{{ product.name }}">
        <h1>{{ product.name }}</h1>
        <h2>
            <a href="{{ product.category.get_absolute_url }}">
                {{ product.category }}
            </a>
        </h2>

        <!-- Chegirma bilan narxni ko'rsatish -->
        <p class="price">
            {% if product.discount > 0 %}
                <span class="old-price">${{ product.price }}</span><br>
                <span class="discounted-price">Now: ${{ product.discount_priced }}</span>
            {% else %}
                ${{ product.price }}
            {% endif %}
        </p>

        <!-- Reyting ko'rsatish -->
        <div class="product-rating">
            <h3>Reyting:</h3>
            <div class="rating">
                {% for i in "*****" %}
                    {% if forloop.counter <= product.rating %}
                        <span class="star filled">‚òÖ</span>
                    {% else %}
                        <span class="star">‚òÜ</span>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Like tugmasi -->
        <button class="like-button {% if is_liked %}liked{% endif %}" id="like-button" data-product-id="{{ product.id }}">
            {% if is_liked %}
                ‚ù§Ô∏è
            {% else %}
                ü§ç
            {% endif %}
        </button>

        <!-- Like count display -->
        <p id="likes-count">{{ likes_count }} Likes</p>

        <!-- Savatga qo'shish formasi -->
        <form action="{% url 'cart:cart_add' product.id %}" method="post">
            {{ cart_product_form }}
            {% csrf_token %}
            <button type="submit" class="btn btn-success">Add to cart</button>
        </form>

        {{ product.description|linebreaks }}
    </div>

    <!-- Izohlar qismini qo'shish -->
    <div class="comments-section">
        <h2>Comments ({{ total_comments }})</h2>
        {% for comment in comments %}
            <div class="comment">
                <p><strong>{{ comment.full_name }}:</strong> {{ comment.message }}</p>
                <p><small>Posted on: {{ comment.created|date:"Y-m-d H:i" }}</small></p>
            </div>
        {% empty %}
            <p>No comments yet. Be the first to comment!</p>
        {% endfor %}
        <a href="{% url 'shop:all_comments' product.id product.slug %}">See all comments</a>
    </div>

    <!-- Yangi izoh qoldirish formasi -->
    <div class="comment-form">
        <h3>Leave a Comment</h3>
        <form method="post" action="{% url 'shop:product_detail' product.id product.slug %}">
            {{ comment_form.as_p }}
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-success">Submit</button>
        </form>
    </div>

    <!-- Like tugmasi uchun JavaScript qo'shish -->
    <script>
        document.getElementById('like-button').addEventListener('click', function() {
            var likeButton = this;
            var productId = likeButton.getAttribute('data-product-id');

            fetch("{% url 'shop:product_like' 0 %}".replace('0', productId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.liked) {
                    likeButton.classList.add('liked');
                    likeButton.innerHTML = '‚ù§Ô∏è'; // Qizil yurak
                } else {
                    likeButton.classList.remove('liked');
                    likeButton.innerHTML = 'ü§ç'; // Oq yurak
                }
                document.getElementById('likes-count').textContent = data.likes_count + ' Likes'; // Update likes count
            });
        });
    </script>

{% endblock %}
